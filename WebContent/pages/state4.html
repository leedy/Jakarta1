<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>People by State</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
    /* Flash highlight effect */
    .flash {
      animation: flash-bg 2.2s ease-in-out 1;
    }
    @keyframes flash-bg {
      0%   { background-color: #fff3cd; }   /* bs-warning-subtle-ish */
      50%  { background-color: #ffe69c; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="h3 mb-4">People by State</h1>

    <!-- Search controls -->
    <div class="row g-3 align-items-end mb-4">
      <div class="col-12 col-sm-6 col-md-4">
        <label for="stateDropdown" class="form-label">State</label>
        <select id="stateDropdown" class="form-select">
          <option value="">Select a state</option>
          <option value="AL">Alabama</option>
          <option value="AK">Alaska</option>
          <option value="AZ">Arizona</option>
          <option value="AR">Arkansas</option>
          <option value="CA">California</option>
          <option value="CO">Colorado</option>
          <option value="CT">Connecticut</option>
          <option value="DE">Delaware</option>
          <option value="FL">Florida</option>
          <option value="GA">Georgia</option>
          <option value="HI">Hawaii</option>
          <option value="ID">Idaho</option>
          <option value="IL">Illinois</option>
          <option value="IN">Indiana</option>
          <option value="IA">Iowa</option>
          <option value="KS">Kansas</option>
          <option value="KY">Kentucky</option>
          <option value="LA">Louisiana</option>
          <option value="ME">Maine</option>
          <option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option>
          <option value="MI">Michigan</option>
          <option value="MN">Minnesota</option>
          <option value="MS">Mississippi</option>
          <option value="MO">Missouri</option>
          <option value="MT">Montana</option>
          <option value="NE">Nebraska</option>
          <option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option>
          <option value="NJ">New Jersey</option>
          <option value="NM">New Mexico</option>
          <option value="NY">New York</option>
          <option value="NC">North Carolina</option>
          <option value="ND">North Dakota</option>
          <option value="OH">Ohio</option>
          <option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option>
          <option value="PA">Pennsylvania</option>
          <option value="RI">Rhode Island</option>
          <option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option>
          <option value="TN">Tennessee</option>
          <option value="TX">Texas</option>
          <option value="UT">Utah</option>
          <option value="VT">Vermont</option>
          <option value="VA">Virginia</option>
          <option value="WA">Washington</option>
          <option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option>
          <option value="WY">Wyoming</option>
        </select>
      </div>
      <div class="col-auto">
        <button id="searchBtn" type="button" class="btn btn-primary">Search</button>
      </div>
      <div class="col-auto">
        <span id="status" class="text-muted small" aria-live="polite"></span>
      </div>
    </div>

    <!-- Create form (top) -->
    <h2 class="h5">Create New Person</h2>
    <form id="createForm" class="row g-3 mb-4">
      <div class="col-sm-6 col-md-4">
        <label class="form-label" for="firstName">First Name</label>
        <input type="text" id="firstName" name="firstName" class="form-control" required>
      </div>
      <div class="col-sm-6 col-md-4">
        <label class="form-label" for="lastName">Last Name</label>
        <input type="text" id="lastName" name="lastName" class="form-control" required>
      </div>
      <div class="col-sm-6 col-md-4">
        <label class="form-label" for="createState">State</label>
        <select id="createState" name="state" class="form-select" required></select>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-success">Create</button>
        <span id="createStatus" class="ms-2 small text-muted"></span>
      </div>
    </form>

    <div id="count" class="mb-2 fw-semibold"></div>

    <!-- Results table -->
    <div class="table-responsive shadow-sm">
      <table id="dataTable" class="table table-sm table-striped table-hover align-middle mb-0" aria-describedby="count">
        <thead class="table-light">
          <tr>
            <th data-key="lastName">Last Name</th>
            <th data-key="firstName">First Name</th>
            <th data-key="state">State</th>
            <th data-key="key">Key</th>
            <th data-key="unid">UNID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Epcot server endpoints
    const ITEM_BASE = "http://epcot.notesin9.test/demoapp/appcode.nsf/xsp/app/people/by-state/item";
    const CREATE_URL = "http://epcot.notesin9.test/demoapp/appcode.nsf/xsp/app/people";

    // Elements
    const dropdown = document.getElementById("stateDropdown");
    const table = document.getElementById("dataTable");
    const tbody = table.querySelector("tbody");
    const statusEl = document.getElementById("status");
    const countEl = document.getElementById("count");
    const searchBtn = document.getElementById("searchBtn");

    const createForm = document.getElementById("createForm");
    const createState = document.getElementById("createState");
    const createStatus = document.getElementById("createStatus");

    // Reuse state options: clone from search dropdown into create dropdown
    Array.from(dropdown.options).forEach(opt => {
      createState.appendChild(opt.cloneNode(true));
    });
    createState.value = dropdown.value;

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    function getHeaderKeys() {
      return Array.from(table.querySelectorAll("thead th")).map(th => th.getAttribute("data-key"));
    }

    function sortRows(rows) {
      return rows.sort((a, b) => {
        const lnA = (a.lastName || "").toLowerCase();
        const lnB = (b.lastName || "").toLowerCase();
        if (lnA < lnB) return -1;
        if (lnA > lnB) return 1;
        const fnA = (a.firstName || "").toLowerCase();
        const fnB = (b.firstName || "").toLowerCase();
        if (fnA < fnB) return -1;
        if (fnA > fnB) return 1;
        return 0;
      });
    }

    function populateTable(rows) {
      tbody.innerHTML = "";
      const keys = getHeaderKeys();
      const frag = document.createDocumentFragment();

      rows.forEach(obj => {
        const tr = document.createElement("tr");
        // For row identification later (highlighting), attach data attributes if available
        if (obj.unid) tr.dataset.unid = obj.unid;
        if (obj.firstName) tr.dataset.firstName = obj.firstName;
        if (obj.lastName) tr.dataset.lastName = obj.lastName;
        if (obj.state) tr.dataset.state = obj.state;

        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = obj && obj[k] ? obj[k] : "";
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      });

      tbody.appendChild(frag);
      countEl.textContent = "Count: " + rows.length;
    }

    async function fetchData(stateAbbreviation) {
      const url = ITEM_BASE + "/" + encodeURIComponent(stateAbbreviation);
      setStatus("Loading...");
      searchBtn.disabled = true;
      dropdown.disabled = true;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
        const json = await res.json();
        const rows = Array.isArray(json.results) ? sortRows(json.results) : [];
        populateTable(rows);
        setStatus(rows.length ? "" : "No results.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + e.message);
        tbody.innerHTML = "";
        countEl.textContent = "";
      } finally {
        searchBtn.disabled = false;
        dropdown.disabled = false;
      }
    }

    function search() {
      const state = dropdown.value.trim();
      if (!state) {
        alert("Please select a state.");
        return;
      }
      createState.value = state;
      fetchData(state);
    }

    // Highlight helper: try to locate the row and flash it
    function highlightCreatedRow(hint) {
      // Prefer UNID if provided
      let row = null;
      if (hint && hint.unid) {
        row = tbody.querySelector('tr[data-unid="' + hint.unid + '"]');
      }
      // Fallback: match on firstName + lastName + state
      if (!row && hint) {
        const sel = 'tr[data-first-name="' + (hint.firstName || "") + '"][data-last-name="' + (hint.lastName || "") + '"][data-state="' + (hint.state || "") + '"]';
        // note: we stored datasets in camelCase; querySelector uses kebab-case
        row = Array.from(tbody.querySelectorAll("tr")).find(tr =>
          (tr.dataset.firstName || "") === (hint.firstName || "") &&
          (tr.dataset.lastName || "") === (hint.lastName || "") &&
          (tr.dataset.state || "") === (hint.state || "")
        );
      }
      if (row) {
        row.classList.remove("flash");
        // force reflow so animation restarts even if same row highlighted twice
        void row.offsetWidth;
        row.classList.add("flash");
        // Scroll into view if it’s far down
        row.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }

    // Create person
    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      createStatus.textContent = "Creating…";
      const person = {
        firstName: createForm.firstName.value.trim(),
        lastName: createForm.lastName.value.trim(),
        state: createForm.state.value.trim()
      };

      try {
        const res = await fetch(CREATE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(person)
        });
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
        const json = await res.json(); // Expecting { unid: "...", ... }
        const createdHint = { ...person, unid: json.unid };

        createStatus.textContent = "Created" + (json.unid ? " (UNID: " + json.unid + ")" : "!");
        createForm.reset();
        createState.value = dropdown.value || person.state;

        // Make sure the current filter shows the created state
        if (dropdown.value !== person.state) dropdown.value = person.state;

        // Refresh and then highlight
        await fetchData(person.state);
        highlightCreatedRow(createdHint);
      } catch (err) {
        console.error(err);
        createStatus.textContent = "Error: " + err.message;
      }
    });

    // Wire up search button and Enter key
    searchBtn.addEventListener("click", search);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); search(); }
    });
  </script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
